name: Verify Branch Protection

# This workflow helps verify that branch protection is configured correctly
# It can be run manually to check the status

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Mondays at 09:00 UTC
    - cron: '0 9 * * 1'

jobs:
  check-protection:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check if settings.yml exists
      run: |
        echo "üîç Checking for branch protection configuration..."
        if [ -f .github/settings.yml ]; then
          echo "‚úÖ Found .github/settings.yml"
          echo "üìã Branch protection settings:"
          cat .github/settings.yml | grep -A 20 "branches:" || echo "No branch settings found"
        else
          echo "‚ùå .github/settings.yml not found"
        fi
    
    - name: Check CI workflow
      run: |
        echo "üîç Checking CI workflow configuration..."
        if [ -f .github/workflows/ci.yml ]; then
          echo "‚úÖ Found .github/workflows/ci.yml"
          echo "üìã CI jobs that should be required status checks:"
          echo ""
          grep -E "^  [a-z-]+:" .github/workflows/ci.yml | sed 's/://g' | sed 's/^  /  - /' || true
          echo ""
          echo "Note: For matrix jobs, each variant becomes a separate status check"
          echo "Example: 'build-and-test' with matrix python-version becomes:"
          echo "  - build-and-test (3.10)"
          echo "  - build-and-test (3.11)"
          echo "  - build-and-test (3.12)"
        else
          echo "‚ùå .github/workflows/ci.yml not found"
        fi
    
    - name: Display documentation
      run: |
        echo ""
        echo "üìö Documentation:"
        echo "===================="
        echo ""
        echo "For instructions on how to enable branch protection, see:"
        echo "  .github/BRANCH_PROTECTION.md"
        echo ""
        echo "Quick setup:"
        echo "1. Go to: https://github.com/${{ github.repository }}/settings/branches"
        echo "2. Add a branch protection rule for 'main'"
        echo "3. Enable 'Require status checks to pass before merging'"
        echo "4. Select the required status checks from the CI workflow"
        echo ""
        echo "For detailed instructions, see the documentation file."
        echo ""
    
    - name: Summary
      run: |
        echo "üìä Summary"
        echo "==========="
        echo ""
        echo "Repository: ${{ github.repository }}"
        echo "Default branch: ${{ github.event.repository.default_branch }}"
        echo ""
        echo "‚úÖ Configuration files are in place"
        echo "‚úÖ CI workflow is configured"
        echo ""
        echo "‚ö†Ô∏è  Note: Branch protection must be manually enabled in GitHub settings"
        echo "    or by installing the Probot Settings app."
        echo ""
        echo "üìñ Read .github/BRANCH_PROTECTION.md for detailed instructions"
