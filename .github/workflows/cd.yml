name: CD

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        if [ -f pyproject.toml ]; then
          pip install -e .
        fi

    - name: Build application
      run: |
        if [ -f setup.py ]; then
          python setup.py build
        elif [ -f pyproject.toml ]; then
          pip install build
          python -m build
        else
          echo "No build configuration found. Application is ready to deploy."
        fi

    - name: Create deployment artifact
      run: |
        # Create a deployable artifact
        mkdir -p deployment
        # Copy relevant files (adjust based on your application structure)
        if [ -d dist ]; then
          cp -r dist deployment/
        fi
        if [ -f requirements.txt ]; then
          cp requirements.txt deployment/
        fi
        # Add any additional files needed for deployment
        tar -czf safemap-deployment.tar.gz deployment/

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: safemap-deployment-${{ github.sha }}
        path: safemap-deployment.tar.gz

    - name: Deploy notification
      run: |
        echo "Deployment artifact created successfully"
        echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
        echo "SHA: ${{ github.sha }}"
        echo "To complete deployment, download the artifact and deploy to your hosting service"
        # Add actual deployment steps here based on your hosting provider
        # Examples:
        # - Deploy to Azure App Service
        # - Deploy to AWS Elastic Beanstalk
        # - Deploy to Google Cloud Run
        # - Deploy to Heroku
        # - Deploy to custom server via SSH
